name: Cost Monitoring

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ã«å®Ÿè¡Œï¼ˆAWSç„¡æ–™æ ã®ä½¿ç”¨é‡ãƒã‚§ãƒƒã‚¯ï¼‰
    - cron: '0 9 * * *'
  workflow_dispatch:

jobs:
  cost-check:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup AWS CLI
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Check Lambda invocation count
        run: |
          echo "Lambdaé–¢æ•°ã®å®Ÿè¡Œå›æ•°ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          # æœˆåˆã‹ã‚‰ã®å®Ÿè¡Œå›æ•°ã‚’å–å¾—ï¼ˆç„¡æ–™æ : æœˆ100ä¸‡å›ï¼‰
          aws logs describe-metric-filters --region us-east-1 || echo "Lambdaé–¢æ•°ãŒã¾ã ä½œæˆã•ã‚Œã¦ã„ã¾ã›ã‚“"

      - name: Check Amplify bandwidth usage
        run: |
          echo "Amplifyã®è»¢é€é‡ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
          # ç„¡æ–™æ : æœˆ5GB
          echo "æ‰‹å‹•ã§AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™"

      - name: Cost alert notification
        run: |
          echo "ğŸš¨ AWSç„¡æ–™æ ã®ç›£è¦–"
          echo "- Lambda: æœˆ100ä¸‡å›ã¾ã§ç„¡æ–™"
          echo "- Amplify Hosting: æœˆ5GBè»¢é€ã¾ã§ç„¡æ–™"
          echo "- API Gateway: æœˆ100ä¸‡ã‚³ãƒ¼ãƒ«ã¾ã§ç„¡æ–™"
          echo "å®šæœŸçš„ã«AWSã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã‚³ã‚¹ãƒˆã‚’ç¢ºèªã—ã¦ãã ã•ã„"